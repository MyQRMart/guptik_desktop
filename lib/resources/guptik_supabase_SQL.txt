-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.account_alerts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  alert_type character varying,
  severity character varying CHECK (severity::text = ANY (ARRAY['low'::character varying::text, 'medium'::character varying::text, 'high'::character varying::text, 'critical'::character varying::text])),
  message text,
  is_resolved boolean DEFAULT false,
  raw_data jsonb,
  created_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  CONSTRAINT account_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT account_alerts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.ai_agents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name character varying NOT NULL,
  system_prompt text,
  model character varying DEFAULT 'gpt-3.5-turbo'::character varying,
  is_active boolean DEFAULT false,
  auto_reply_enabled boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_agents_pkey PRIMARY KEY (id),
  CONSTRAINT ai_agents_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.business_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  profile_image_url text,
  description text CHECK (char_length(description) <= 512),
  about text CHECK (char_length(about) <= 140),
  address text,
  category text NOT NULL DEFAULT 'Education'::text CHECK (category = ANY (ARRAY['Education'::text, 'Business Services'::text, 'Health & Medical'::text, 'Technology'::text, 'Retail & Shopping'::text, 'Food & Beverage'::text, 'Finance & Banking'::text, 'Other'::text])),
  website_url_1 text CHECK (website_url_1 IS NULL OR website_url_1 ~* '^https?://'::text),
  website_url_2 text CHECK (website_url_2 IS NULL OR website_url_2 ~* '^https?://'::text),
  email text CHECK (email IS NULL OR email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text),
  has_compliance_info boolean NOT NULL DEFAULT false,
  legal_name text,
  business_type text NOT NULL DEFAULT 'Select type'::text CHECK (business_type = ANY (ARRAY['Select type'::text, 'Sole Proprietorship'::text, 'Partnership'::text, 'Private Limited'::text, 'Public Limited'::text, 'LLP'::text, 'NGO'::text, 'Government'::text, 'Other'::text])),
  grievance_name text,
  grievance_email text CHECK (grievance_email IS NULL OR grievance_email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text),
  grievance_landline text,
  grievance_mobile text,
  customer_care_email text CHECK (customer_care_email IS NULL OR customer_care_email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text),
  customer_care_landline text,
  customer_care_mobile text,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT business_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT business_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.conversations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  ai_agent_id uuid,
  phone_number character varying NOT NULL,
  contact_name character varying,
  contact_email text,
  contact_notes text,
  last_message text,
  last_message_time text NOT NULL,
  is_unread boolean DEFAULT true,
  is_archived boolean DEFAULT false,
  created_at text NOT NULL DEFAULT (now() AT TIME ZONE 'ist'::text),
  updated_at timestamp with time zone DEFAULT (now() AT TIME ZONE 'utc'::text),
  CONSTRAINT conversations_pkey PRIMARY KEY (id),
  CONSTRAINT conversations_ai_agent_id_fkey FOREIGN KEY (ai_agent_id) REFERENCES public.ai_agents(id),
  CONSTRAINT conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.desktop_devices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  device_id text NOT NULL UNIQUE,
  device_name text,
  device_model text,
  vault_path text,
  services_path text,
  is_verified boolean DEFAULT false,
  installation_status text DEFAULT 'pending'::text,
  last_active_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT desktop_devices_pkey PRIMARY KEY (id),
  CONSTRAINT desktop_devices_user FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.hc_boards (
  id text NOT NULL,
  home_id text,
  room_id text,
  owner_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  location text,
  mac_address text,
  status text NOT NULL DEFAULT 'offline'::text CHECK (status = ANY (ARRAY['online'::text, 'offline'::text, 'maintenance'::text])),
  firmware_version text,
  last_online timestamp with time zone,
  connection_info jsonb DEFAULT '{}'::jsonb,
  metadata jsonb DEFAULT '{}'::jsonb,
  is_active boolean NOT NULL DEFAULT true,
  is_claimed boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hc_boards_pkey PRIMARY KEY (id),
  CONSTRAINT boards_home_id_fkey FOREIGN KEY (home_id) REFERENCES public.hc_homes(id),
  CONSTRAINT boards_room_id_fkey FOREIGN KEY (room_id) REFERENCES public.hc_rooms(id),
  CONSTRAINT boards_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES auth.users(id)
);
CREATE TABLE public.hc_home_members (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  home_id text NOT NULL,
  user_id uuid NOT NULL,
  role text DEFAULT 'member'::text CHECK (role = ANY (ARRAY['owner'::text, 'admin'::text, 'member'::text])),
  permissions jsonb DEFAULT '{"can_control": true, "can_add_devices": false, "can_manage_users": false, "can_delete_devices": false}'::jsonb,
  invited_by uuid,
  joined_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hc_home_members_pkey PRIMARY KEY (id),
  CONSTRAINT home_members_home_id_fkey FOREIGN KEY (home_id) REFERENCES public.hc_homes(id),
  CONSTRAINT home_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT home_members_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES auth.users(id)
);
CREATE TABLE public.hc_home_shares (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  home_id text NOT NULL,
  owner_id uuid NOT NULL,
  shared_with_id uuid,
  referral_code text UNIQUE,
  can_control boolean DEFAULT true,
  is_active boolean DEFAULT true,
  max_uses integer DEFAULT 1,
  current_uses integer DEFAULT 0,
  expires_at timestamp with time zone,
  shared_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  used_by ARRAY DEFAULT '{}'::uuid[],
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT hc_home_shares_pkey PRIMARY KEY (id),
  CONSTRAINT home_shares_home_id_fkey FOREIGN KEY (home_id) REFERENCES public.hc_homes(id),
  CONSTRAINT home_shares_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES auth.users(id),
  CONSTRAINT home_shares_shared_with_id_fkey FOREIGN KEY (shared_with_id) REFERENCES auth.users(id)
);
CREATE TABLE public.hc_homes (
  id text NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  wallpaper_path text,
  address text,
  city text,
  country text,
  location text,
  timezone text DEFAULT 'UTC'::text,
  is_primary boolean DEFAULT false,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hc_homes_pkey PRIMARY KEY (id),
  CONSTRAINT homes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.hc_rooms (
  id text NOT NULL,
  home_id text NOT NULL,
  name text NOT NULL,
  description text,
  icon text DEFAULT 'meeting_room'::text,
  display_order integer DEFAULT 0,
  metadata jsonb DEFAULT '{}'::jsonb,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hc_rooms_pkey PRIMARY KEY (id),
  CONSTRAINT rooms_home_id_fkey FOREIGN KEY (home_id) REFERENCES public.hc_homes(id)
);
CREATE TABLE public.hc_switch_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  switch_id text NOT NULL,
  board_id text,
  user_id uuid,
  action text NOT NULL,
  state boolean,
  previous_state jsonb,
  new_state jsonb,
  triggered_by text DEFAULT 'manual'::text,
  user_name text,
  ip_address inet,
  user_agent text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hc_switch_logs_pkey PRIMARY KEY (id),
  CONSTRAINT switch_logs_switch_id_fkey FOREIGN KEY (switch_id) REFERENCES public.hc_switches(id),
  CONSTRAINT switch_logs_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.hc_boards(id),
  CONSTRAINT switch_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.hc_switches (
  id text NOT NULL,
  board_id text NOT NULL,
  name text NOT NULL,
  type text NOT NULL DEFAULT 'light'::text CHECK (type = ANY (ARRAY['light'::text, 'fan'::text, 'ac'::text, 'heater'::text, 'plug'::text, 'other'::text])),
  icon text,
  position integer NOT NULL DEFAULT 0,
  state boolean NOT NULL DEFAULT false,
  is_enabled boolean NOT NULL DEFAULT true,
  last_state_change timestamp with time zone DEFAULT now(),
  power_rating numeric,
  location text DEFAULT ''::text,
  description text,
  alexa_enabled boolean DEFAULT true,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hc_switches_pkey PRIMARY KEY (id),
  CONSTRAINT switches_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.hc_boards(id)
);
CREATE TABLE public.hc_timers (
  id text NOT NULL,
  switch_id text NOT NULL,
  user_id uuid NOT NULL,
  name text,
  type text NOT NULL DEFAULT 'scheduled'::text CHECK (type = ANY (ARRAY['scheduled'::text, 'prescheduled'::text, 'countdown'::text])),
  time text NOT NULL,
  trigger_time time without time zone,
  days ARRAY DEFAULT '{}'::text[],
  days_of_week ARRAY DEFAULT '{}'::integer[],
  action boolean NOT NULL DEFAULT true,
  state boolean NOT NULL DEFAULT true,
  is_enabled boolean NOT NULL DEFAULT true,
  is_active boolean NOT NULL DEFAULT true,
  scheduled_date timestamp with time zone,
  last_run timestamp with time zone,
  next_run timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hc_timers_pkey PRIMARY KEY (id),
  CONSTRAINT timers_switch_id_fkey FOREIGN KEY (switch_id) REFERENCES public.hc_switches(id),
  CONSTRAINT timers_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT timers_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.hc_water_readings (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  device_id text NOT NULL,
  home_id text,
  temperature numeric,
  tds_value integer,
  flow_rate_sensor1 numeric,
  flow_rate_sensor2 numeric,
  total_flow_rate numeric,
  total_water numeric,
  pulse_count1 integer,
  pulse_count2 integer,
  elapsed_time integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT hc_water_readings_pkey PRIMARY KEY (id, created_at),
  CONSTRAINT water_readings_home_id_fkey FOREIGN KEY (home_id) REFERENCES public.hc_homes(id)
);
CREATE TABLE public.message_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  date date NOT NULL,
  incoming_count integer DEFAULT 0,
  outgoing_count integer DEFAULT 0,
  ai_outgoing_count integer DEFAULT 0,
  template_used_count integer DEFAULT 0,
  avg_response_time_seconds numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT message_analytics_pkey PRIMARY KEY (id),
  CONSTRAINT message_analytics_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.message_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name character varying NOT NULL CHECK (length(TRIM(BOTH FROM name)) > 0),
  category character varying NOT NULL DEFAULT 'General'::character varying CHECK (category::text = ANY (ARRAY['Marketing'::character varying::text, 'Utility'::character varying::text, 'Authentication'::character varying::text, 'General'::character varying::text, 'Greeting'::character varying::text, 'Business'::character varying::text, 'Support'::character varying::text, 'Promotion'::character varying::text, 'Reminder'::character varying::text])),
  language character varying NOT NULL DEFAULT 'English'::character varying,
  type character varying NOT NULL DEFAULT 'Custom'::character varying,
  status character varying NOT NULL DEFAULT 'DRAFT'::character varying CHECK (status::text = ANY (ARRAY['DRAFT'::character varying::text, 'PENDING'::character varying::text, 'APPROVED'::character varying::text, 'REJECTED'::character varying::text])),
  header_type character varying DEFAULT 'None'::character varying CHECK (header_type::text = ANY (ARRAY['None'::character varying::text, 'Text'::character varying::text, 'Image'::character varying::text, 'Video'::character varying::text, 'Document'::character varying::text])),
  header text,
  message text NOT NULL CHECK (length(TRIM(BOTH FROM message)) > 0),
  footer text,
  usage_count integer DEFAULT 0,
  is_favorite boolean DEFAULT false,
  last_used_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  buttons jsonb,
  CONSTRAINT message_templates_pkey PRIMARY KEY (id),
  CONSTRAINT message_templates_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  message_id character varying NOT NULL UNIQUE,
  content text NOT NULL,
  message_type character varying NOT NULL DEFAULT 'text'::character varying CHECK (message_type::text = ANY (ARRAY['text'::character varying::text, 'image'::character varying::text, 'video'::character varying::text, 'audio'::character varying::text, 'document'::character varying::text, 'location'::character varying::text, 'contacts'::character varying::text, 'sticker'::character varying::text, 'reaction'::character varying::text])),
  direction character varying NOT NULL CHECK (direction::text = ANY (ARRAY['incoming'::character varying::text, 'outgoing'::character varying::text, 'ai_outgoing'::character varying::text])),
  status character varying,
  timestamp text NOT NULL,
  status_timestamp text,
  template_id uuid,
  media_info jsonb,
  raw_data jsonb,
  created_at text NOT NULL,
  updated_at text NOT NULL,
  CONSTRAINT messages_pkey PRIMARY KEY (id),
  CONSTRAINT messages_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.message_templates(id),
  CONSTRAINT messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id)
);
CREATE TABLE public.scheduled_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  conversation_id uuid NOT NULL,
  template_id uuid,
  message_text text,
  scheduled_for timestamp with time zone NOT NULL,
  sent_at timestamp with time zone,
  status character varying NOT NULL DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::text, 'sent'::text, 'failed'::text, 'cancelled'::text])),
  retry_count integer DEFAULT 0,
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT scheduled_messages_pkey PRIMARY KEY (id),
  CONSTRAINT scheduled_messages_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.message_templates(id),
  CONSTRAINT scheduled_messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT scheduled_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id)
);
CREATE TABLE public.trust_me_invites (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  creator_id uuid NOT NULL,
  invite_code text NOT NULL UNIQUE,
  expires_at timestamp with time zone NOT NULL,
  is_used boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trust_me_invites_pkey PRIMARY KEY (id),
  CONSTRAINT trust_me_invites_creator_id_fkey FOREIGN KEY (creator_id) REFERENCES auth.users(id)
);
CREATE TABLE public.trust_me_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  sender_id uuid NOT NULL,
  recipient_id uuid NOT NULL,
  encrypted_payload text NOT NULL,
  media_url text,
  expires_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trust_me_messages_pkey PRIMARY KEY (id),
  CONSTRAINT trust_me_messages_sender FOREIGN KEY (sender_id) REFERENCES auth.users(id)
);
CREATE TABLE public.trust_me_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_a_id uuid NOT NULL,
  user_b_id uuid NOT NULL,
  encryption_key_hash text,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['pending'::text, 'active'::text, 'terminated'::text])),
  last_active_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trust_me_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT trust_me_sessions_user_a_fkey FOREIGN KEY (user_a_id) REFERENCES auth.users(id),
  CONSTRAINT trust_me_sessions_user_b_fkey FOREIGN KEY (user_b_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_api_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  whatsapp_access_token text,
  meta_wa_phone_number_id text,
  meta_business_account_id text,
  google_client_id text,
  google_client_secret text,
  apple_client_id text,
  apple_team_id text,
  webhook_verified boolean DEFAULT false,
  webhook_verified_at timestamp with time zone,
  openai_api_key text,
  anthropic_api_key text,
  google_ai_api_key text,
  rate_limit_per_minute integer DEFAULT 60,
  callback_url text DEFAULT 'https://app.metafly.com/webhooks'::text,
  verify_token text DEFAULT 'meta-fly'::text,
  metafly_api_key text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  mobile_number text DEFAULT ''::text UNIQUE,
  username text NOT NULL DEFAULT 'user'::text,
  email text NOT NULL UNIQUE,
  hc_role text NOT NULL DEFAULT 'user'::text CHECK (hc_role = ANY (ARRAY['admin'::text, 'user'::text, 'guest'::text])),
  location text,
  facebook_access_token text,
  instagram_access_token text,
  CONSTRAINT user_api_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_api_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.vault_files (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  file_name text NOT NULL,
  file_path text NOT NULL,
  file_type text,
  mime_type text,
  size_bytes bigint,
  is_favorite boolean DEFAULT false,
  synced_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT vault_files_pkey PRIMARY KEY (id),
  CONSTRAINT vault_files_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.webhook_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  webhook_type character varying,
  status character varying CHECK (status::text = ANY (ARRAY['success'::character varying::text, 'error'::character varying::text, 'skipped'::character varying::text, 'pending'::character varying::text])),
  payload jsonb NOT NULL,
  response jsonb,
  error_message text,
  processing_time_ms integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT webhook_logs_pkey PRIMARY KEY (id),
  CONSTRAINT webhook_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.whatsapp_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  category text NOT NULL,
  language text NOT NULL,
  body text NOT NULL,
  footer text,
  variables jsonb,
  buttons jsonb,
  status text NOT NULL DEFAULT 'pending'::text,
  created_at timestamp without time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone,
  header_media_url text,
  header_text text,
  sample_content jsonb,
  meta_business_account_id text,
  whatsapp_phone_number_id text,
  CONSTRAINT whatsapp_templates_pkey PRIMARY KEY (id)
);